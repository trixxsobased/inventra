@extends('layouts.app')

@section('title', 'Pengajuan Pembelian')
@section('page-title', 'Pengajuan Pembelian')

@section('content')
<div class="page-heading">
    <div class="d-flex justify-content-between align-items-center">
        <h3>Daftar Pengajuan Pembelian</h3>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createModal">
            <i class="bi bi-plus-circle"></i> Buat Pengajuan Baru
        </button>
    </div>
</div>

<div class="page-content">
    @if(session('success'))
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            {{ session('success') }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    @endif

    @if(session('warning'))
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            {{ session('warning') }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    @endif

    <div class="card">
        <div class="card-body">
            <!-- Filter -->
            <form method="GET" action="{{ route('admin.purchase-requisitions.index') }}" class="row mb-3">
                <div class="col-md-3">
                    <select name="status" class="form-select" onchange="this.form.submit()">
                        <option value="all">Semua Status</option>
                        <option value="pending" {{ request('status') === 'pending' ? 'selected' : '' }}>Pending</option>
                        <option value="approved" {{ request('status') === 'approved' ? 'selected' : '' }}>Approved</option>
                        <option value="rejected" {{ request('status') === 'rejected' ? 'selected' : '' }}>Rejected</option>
                        <option value="ordered" {{ request('status') === 'ordered' ? 'selected' : '' }}>Ordered</option>
                        <option value="received" {{ request('status') === 'received' ? 'selected' : '' }}>Received</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select name="priority" class="form-select" onchange="this.form.submit()">
                        <option value="all">Semua Prioritas</option>
                        <option value="urgent" {{ request('priority') === 'urgent' ? 'selected' : '' }}>Urgent</option>
                        <option value="high" {{ request('priority') === 'high' ? 'selected' : '' }}>High</option>
                        <option value="medium" {{ request('priority') === 'medium' ? 'selected' : '' }}>Medium</option>
                        <option value="low" {{ request('priority') === 'low' ? 'selected' : '' }}>Low</option>
                    </select>
                </div>
            </form>

            <!-- Table -->
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th width="5%">#</th>
                            <th>Nama Alat</th>
                            <th>Kategori</th>
                            <th>Qty</th>
                            <th>Est. Harga</th>
                            <th>Alasan</th>
                            <th>Prioritas</th>
                            <th>Status</th>
                            <th>Diajukan</th>
                            <th width="10%">Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        @forelse($requisitions as $index => $req)
                            <tr>
                                <td>{{ $requisitions->firstItem() + $index }}</td>
                                <td><strong>{{ $req->item_name }}</strong></td>
                                <td>{{ $req->category->name }}</td>
                                <td>{{ $req->quantity }}</td>
                                <td>Rp {{ number_format($req->estimated_price, 0, ',', '.') }}</td>
                                <td>
                                    @if($req->reason === 'replacement')
                                        <span class="badge bg-warning">Pengganti</span>
                                    @elseif($req->reason === 'new_stock')
                                        <span class="badge bg-info">Stok Baru</span>
                                    @else
                                        <span class="badge bg-success">Ekspansi</span>
                                    @endif
                                </td>
                                <td>
                                    @if($req->priority === 'urgent')
                                        <span class="badge bg-danger">URGENT</span>
                                    @elseif($req->priority === 'high')
                                        <span class="badge bg-warning">High</span>
                                    @elseif($req->priority === 'medium')
                                        <span class="badge bg-info">Medium</span>
                                    @else
                                        <span class="badge bg-secondary">Low</span>
                                    @endif
                                </td>
                                <td>
                                    @if($req->status === 'pending')
                                        <span class="badge bg-secondary">Pending</span>
                                    @elseif($req->status === 'approved')
                                        <span class="badge bg-success">Approved</span>
                                    @elseif($req->status === 'rejected')
                                        <span class="badge bg-danger">Rejected</span>
                                    @elseif($req->status === 'ordered')
                                        <span class="badge bg-primary">Ordered</span>
                                    @else
                                        <span class="badge bg-success">Received</span>
                                    @endif
                                </td>
                                <td>
                                    <small>{{ $req->created_at->format('d/m/Y') }}</small><br>
                                    <small class="text-muted">{{ $req->requestedBy->name }}</small>
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button type="button"
                                                class="btn btn-sm btn-info"
                                                data-bs-toggle="modal"
                                                data-bs-target="#detailModal{{ $req->id }}"
                                                title="Detail">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                        @if($req->status === 'pending')
                                            <button type="button"
                                                    class="btn btn-sm btn-warning"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#editModal{{ $req->id }}"
                                                    title="Edit">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                        @endif
                                    </div>
                                </td>
                            </tr>

                            {{-- Detail Modal --}}
                            <div class="modal fade" id="detailModal{{ $req->id }}" tabindex="-1">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">Detail Pengajuan #{{ $req->id }}</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body">
                                            <table class="table table-borderless">
                                                <tr>
                                                    <th width="35%">Nama Alat</th>
                                                    <td><strong>{{ $req->item_name }}</strong></td>
                                                </tr>
                                                <tr>
                                                    <th>Kategori</th>
                                                    <td>{{ $req->category->name }}</td>
                                                </tr>
                                                <tr>
                                                    <th>Jumlah</th>
                                                    <td>{{ $req->quantity }} unit</td>
                                                </tr>
                                                <tr>
                                                    <th>Harga/unit</th>
                                                    <td>Rp {{ number_format($req->estimated_price, 0, ',', '.') }}</td>
                                                </tr>
                                                <tr>
                                                    <th>Total Estimasi</th>
                                                    <td><strong class="text-primary">Rp {{ number_format($req->estimated_price * $req->quantity, 0, ',', '.') }}</strong></td>
                                                </tr>
                                                <tr>
                                                    <th>Alasan</th>
                                                    <td>
                                                        @if($req->reason === 'replacement')
                                                            <span class="badge bg-warning">Pengganti Rusak</span>
                                                        @elseif($req->reason === 'new_stock')
                                                            <span class="badge bg-info">Stok Baru</span>
                                                        @else
                                                            <span class="badge bg-success">Ekspansi</span>
                                                        @endif
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th>Prioritas</th>
                                                    <td>
                                                        @if($req->priority === 'urgent')
                                                            <span class="badge bg-danger">URGENT</span>
                                                        @elseif($req->priority === 'high')
                                                            <span class="badge bg-warning">High</span>
                                                        @elseif($req->priority === 'medium')
                                                            <span class="badge bg-info">Medium</span>
                                                        @else
                                                            <span class="badge bg-secondary">Low</span>
                                                        @endif
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th>Status</th>
                                                    <td>
                                                        @if($req->status === 'pending')
                                                            <span class="badge bg-secondary">Pending</span>
                                                        @elseif($req->status === 'approved')
                                                            <span class="badge bg-success">Approved</span>
                                                        @elseif($req->status === 'rejected')
                                                            <span class="badge bg-danger">Rejected</span>
                                                        @elseif($req->status === 'ordered')
                                                            <span class="badge bg-primary">Ordered</span>
                                                        @else
                                                            <span class="badge bg-success">Received</span>
                                                        @endif
                                                    </td>
                                                </tr>
                                            </table>

                                            <hr>
                                            <h6>Justifikasi</h6>
                                            <div class="alert alert-light">
                                                {{ $req->justification }}
                                            </div>

                                            @if($req->reviewed_at)
                                                <hr>
                                                <h6>Review</h6>
                                                <p class="mb-1"><strong>Direview oleh:</strong> {{ $req->reviewedBy->name }}</p>
                                                <p class="mb-1"><strong>Tanggal:</strong> {{ $req->reviewed_at->format('d/m/Y H:i') }}</p>
                                                @if($req->review_notes)
                                                    <div class="alert alert-{{ $req->status === 'approved' ? 'success' : 'danger' }} mt-2">
                                                        {{ $req->review_notes }}
                                                    </div>
                                                @endif
                                            @endif

                                            <hr>
                                            <p class="mb-1"><strong>Diajukan oleh:</strong> {{ $req->requestedBy->name }}</p>
                                            <p class="mb-0"><strong>Tanggal:</strong> {{ $req->created_at->format('d/m/Y H:i') }}</p>
                                        </div>
                                        <div class="modal-footer">
                                            @if($req->status === 'pending' && auth()->user()->role === 'admin')
                                                <form action="{{ route('admin.purchase-requisitions.approve', $req) }}" method="POST" class="d-inline">
                                                    @csrf
                                                    <button type="submit" class="btn btn-success btn-sm" onclick="return confirm('Approve pengajuan ini?')">
                                                        <i class="bi bi-check-circle"></i> Approve
                                                    </button>
                                                </form>
                                                <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#rejectModal{{ $req->id }}">
                                                    <i class="bi bi-x-circle"></i> Reject
                                                </button>
                                            @endif
                                            <a href="{{ route('admin.purchase-requisitions.export-pdf', $req) }}" 
                                               class="btn btn-danger btn-sm" 
                                               target="_blank">
                                                <i class="bi bi-file-pdf"></i> Cetak PDF
                                            </a>
                                            <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Tutup</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {{-- Reject Modal --}}
                            @if($req->status === 'pending')
                            <div class="modal fade" id="rejectModal{{ $req->id }}" tabindex="-1">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <form action="{{ route('admin.purchase-requisitions.reject', $req) }}" method="POST">
                                            @csrf
                                            <div class="modal-header">
                                                <h5 class="modal-title">Reject Pengajuan #{{ $req->id }}</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                            </div>
                                            <div class="modal-body">
                                                <div class="alert alert-warning">
                                                    <i class="bi bi-exclamation-triangle"></i>
                                                    Anda akan menolak pengajuan ini.
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Alasan Penolakan <span class="text-danger">*</span></label>
                                                    <textarea name="review_notes" class="form-control" rows="3" required placeholder="Jelaskan alasan penolakan..."></textarea>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                                                <button type="submit" class="btn btn-danger">
                                                    <i class="bi bi-x-circle"></i> Reject
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            @endif

                            {{-- Edit Modal for each requisition --}}
                            @if($req->status === 'pending')
                            <div class="modal fade" id="editModal{{ $req->id }}" tabindex="-1">
                                <div class="modal-dialog modal-lg modal-dialog-scrollable">
                                    <div class="modal-content">
                                        <form action="{{ route('admin.purchase-requisitions.update', $req) }}" method="POST">
                                            @csrf
                                            @method('PUT')
                                            
                                            <div class="modal-header">
                                                <h5 class="modal-title">Edit Pengajuan #{{ $req->id }}</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                            </div>
                                            
                                            <div class="modal-body">
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label class="form-label">Kategori <span class="text-danger">*</span></label>
                                                        <select class="form-select" name="category_id" required>
                                                            <option value="">-- Pilih --</option>
                                                            @foreach($categories as $cat)
                                                                <option value="{{ $cat->id }}" {{ $req->category_id == $cat->id ? 'selected' : '' }}>{{ $cat->name }}</option>
                                                            @endforeach
                                                        </select>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label class="form-label">Nama Alat <span class="text-danger">*</span></label>
                                                        <input type="text" class="form-control" name="item_name" value="{{ $req->item_name }}" required>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-4 mb-3">
                                                        <label class="form-label">Jumlah <span class="text-danger">*</span></label>
                                                        <input type="number" class="form-control" name="quantity" value="{{ $req->quantity }}" min="1" required>
                                                    </div>
                                                    <div class="col-md-8 mb-3">
                                                        <label class="form-label">Est. Harga/unit <span class="text-danger">*</span></label>
                                                        <input type="number" class="form-control" name="estimated_price" value="{{ $req->estimated_price }}" min="0" step="1000" required>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label class="form-label">Alasan <span class="text-danger">*</span></label>
                                                        <select class="form-select" name="reason" required>
                                                            <option value="replacement" {{ $req->reason === 'replacement' ? 'selected' : '' }}>Pengganti Barang Rusak</option>
                                                            <option value="new_stock" {{ $req->reason === 'new_stock' ? 'selected' : '' }}>Menambah Stok</option>
                                                            <option value="expansion" {{ $req->reason === 'expansion' ? 'selected' : '' }}>Ekspansi</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label class="form-label">Prioritas <span class="text-danger">*</span></label>
                                                        <select class="form-select" name="priority" required>
                                                            <option value="low" {{ $req->priority === 'low' ? 'selected' : '' }}>Low</option>
                                                            <option value="medium" {{ $req->priority === 'medium' ? 'selected' : '' }}>Medium</option>
                                                            <option value="high" {{ $req->priority === 'high' ? 'selected' : '' }}>High</option>
                                                            <option value="urgent" {{ $req->priority === 'urgent' ? 'selected' : '' }}>URGENT</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Justifikasi <span class="text-danger">*</span></label>
                                                    <textarea class="form-control" name="justification" rows="4" required>{{ $req->justification }}</textarea>
                                                </div>
                                            </div>
                                            
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                                                <button type="submit" class="btn btn-primary">
                                                    <i class="bi bi-save"></i> Simpan
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            @endif
                        @empty
                            <tr>
                                <td colspan="10" class="text-center py-4">
                                    <i class="bi bi-inbox fs-2 text-muted"></i>
                                    <p class="text-muted mt-2">Belum ada pengajuan pembelian</p>
                                </td>
                            </tr>
                        @endforelse
                    </tbody>
                </table>
            </div>

            <div class="mt-3">
                {{ $requisitions->links() }}
            </div>
        </div>
    </div>
</div>

{{-- Create Modal --}}
<div class="modal fade" id="createModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <form action="{{ route('admin.purchase-requisitions.store') }}" method="POST">
                @csrf
                
                <div class="modal-header">
                    <h5 class="modal-title">Buat Pengajuan Pembelian Baru</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="create_category_id" class="form-label">Kategori Alat <span class="text-danger">*</span></label>
                            <select class="form-select @error('category_id') is-invalid @enderror" 
                                    id="create_category_id" 
                                    name="category_id" 
                                    required>
                                <option value="">-- Pilih Kategori --</option>
                                @foreach($categories as $category)
                                    <option value="{{ $category->id }}" {{ old('category_id') == $category->id ? 'selected' : '' }}>
                                        {{ $category->name }}
                                    </option>
                                @endforeach
                            </select>
                            @error('category_id')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="create_item_name" class="form-label">Nama Alat <span class="text-danger">*</span></label>
                            <input type="text" 
                                   class="form-control @error('item_name') is-invalid @enderror" 
                                   id="create_item_name" 
                                   name="item_name" 
                                   value="{{ old('item_name') }}"
                                   placeholder="Contoh: Laptop Asus ROG"
                                   required>
                            @error('item_name')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="create_quantity" class="form-label">Jumlah <span class="text-danger">*</span></label>
                            <input type="number" 
                                   class="form-control @error('quantity') is-invalid @enderror" 
                                   id="create_quantity" 
                                   name="quantity" 
                                   value="{{ old('quantity', 1) }}"
                                   min="1"
                                   required>
                            @error('quantity')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>

                        <div class="col-md-8 mb-3">
                            <label for="create_estimated_price" class="form-label">Estimasi Harga (per unit) <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">Rp</span>
                                <input type="number" 
                                       class="form-control @error('estimated_price') is-invalid @enderror" 
                                       id="create_estimated_price" 
                                       name="estimated_price" 
                                       value="{{ old('estimated_price', 0) }}"
                                       min="0"
                                       step="1000"
                                       required>
                                @error('estimated_price')
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="create_reason" class="form-label">Alasan Pengajuan <span class="text-danger">*</span></label>
                            <select class="form-select @error('reason') is-invalid @enderror" 
                                    id="create_reason" 
                                    name="reason" 
                                    required>
                                <option value="">-- Pilih Alasan --</option>
                                <option value="replacement" {{ old('reason') === 'replacement' ? 'selected' : '' }}>Pengganti Barang Rusak</option>
                                <option value="new_stock" {{ old('reason') === 'new_stock' ? 'selected' : '' }}>Menambah Stok</option>
                                <option value="expansion" {{ old('reason') === 'expansion' ? 'selected' : '' }}>Ekspansi/Pengembangan</option>
                            </select>
                            @error('reason')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="create_priority" class="form-label">Tingkat Prioritas <span class="text-danger">*</span></label>
                            <select class="form-select @error('priority') is-invalid @enderror" 
                                    id="create_priority" 
                                    name="priority" 
                                    required>
                                <option value="medium" {{ old('priority') === 'medium' ? 'selected' : '' }}>Medium (Normal)</option>
                                <option value="low" {{ old('priority') === 'low' ? 'selected' : '' }}>Low</option>
                                <option value="high" {{ old('priority') === 'high' ? 'selected' : '' }}>High</option>
                                <option value="urgent" {{ old('priority') === 'urgent' ? 'selected' : '' }}>URGENT</option>
                            </select>
                            @error('priority')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="create_justification" class="form-label">Justifikasi/Alasan Detail <span class="text-danger">*</span></label>
                        <textarea class="form-control @error('justification') is-invalid @enderror" 
                                  id="create_justification" 
                                  name="justification" 
                                  rows="4"
                                  placeholder="Jelaskan secara detail mengapa alat ini dibutuhkan (minimal 20 karakter)"
                                  required>{{ old('justification') }}</textarea>
                        @error('justification')
                            <div class="invalid-feedback">{{ $message }}</div>
                        @enderror
                        <small class="text-muted">Contoh: "Mengganti 2 unit laptop yang rusak berat untuk persiapan UKK 2026"</small>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-send"></i> Ajukan
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@push('scripts')
<script>
document.addEventListener('DOMContentLoaded', function() {
    @if($errors->any())
        var createModal = new bootstrap.Modal(document.getElementById('createModal'));
        createModal.show();
    @endif
});
</script>
@endpush
@endsection
